-- Kill

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local AdminModule = require(game.ServerScriptService:WaitForChild("AdminModule"))  -- Adjust the path as needed

local activeKillLoops = {}

local function executeHumanoidDamage(humanoid)
    local args = {
        [1] = humanoid,
        [2] = "inf"
    }
    ReplicatedStorage.Remotes.DamageHumanoid:FireServer(unpack(args))
end

local function setupChatListener(plr)
    plr.Chatted:Connect(function(msg)
        local FirstWord, User = msg:match("^(;kill)%s*(.+)$")
        local _, TargetUser = msg:match("^(;loopkill)%s*(.+)$")
        local _, UnloopUser = msg:match("^(;unloopkill)%s*(.+)$")

        if FirstWord and User and AdminModule.isAdmin(plr) then
            local targetPlayer = Players:FindFirstChild(User)
            if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("Humanoid") then
                executeHumanoidDamage(targetPlayer.Character.Humanoid)
            end
        elseif TargetUser and AdminModule.isAdmin(plr) then
            local targetPlayer = Players:FindFirstChild(TargetUser)
            if targetPlayer then
                activeKillLoops[targetPlayer] = true
                while activeKillLoops[targetPlayer] and targetPlayer.Character and targetPlayer.Character:FindFirstChild("Humanoid") do
                    executeHumanoidDamage(targetPlayer.Character.Humanoid)
                    wait(1)  -- Adjust the wait time as needed
                end
            end
        elseif UnloopUser and AdminModule.isAdmin(plr) then
            local targetPlayer = Players:FindFirstChild(UnloopUser)
            if targetPlayer then
                activeKillLoops[targetPlayer] = nil
            end
        end
    end)
end

for _, plr in ipairs(Players:GetPlayers()) do
    setupChatListener(plr)
end

Players.PlayerAdded:Connect(setupChatListener)

-- Remove admin

local function setupChatListener2(plr)
    plr.Chatted:Connect(function(msg)
        local FirstWord, User = msg:match("^(;removeadmin)%s*(.+)$")
        
        if FirstWord and User and AdminModule.isAdmin(plr) then
            local targetPlayer = Players:FindFirstChild(User)
            if targetPlayer them
                AdminModule.RemoveAdmin(targetPlayer)
            end
        end
    end)
end

for _, plr in ipairs(Players:GetPlayers()) do
    setupChatListener2(plr)
end

-- Setup chat listener for new players that join
Players.PlayerAdded:Connect(setupChatListener2)

-- Readd admin

local function setupChatListener3(plr)
    plr.Chatted:Connect(function(msg)
        local FirstWord, User = msg:match("^(;addadmin)%s*(.+)$")
        
        if FirstWord and User and AdminModule.isAdmin(plr) then
            local targetPlayer = Players:FindFirstChild(User)
            if targetPlayer them
                AdminModule.AddAdmin(targetPlayer)
            end
        end
    end)
end

for _, plr in ipairs(Players:GetPlayers()) do
    setupChatListener3(plr)
end

-- Setup chat listener for new players that join
Players.PlayerAdded:Connect(setupChatListener3)
